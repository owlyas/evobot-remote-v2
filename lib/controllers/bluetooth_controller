void showBluetoothDialog() {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (BuildContext context) {
        return StatefulBuilder(
          builder: (context, setDialogState) {
            // Filter out devices without a name
            final filteredResults = scanResults
                .where((result) => result.device.platformName.isNotEmpty)
                .toList();

            return AlertDialog(
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(20),
              ),
              backgroundColor: Colors.grey[50],
              title: Row(
                children: [
                  Icon(Icons.bluetooth, color: Colors.blueAccent),
                  SizedBox(width: 10),
                  Text(
                    'Bluetooth Devices',
                    style: TextStyle(
                      color: Colors.blueAccent,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
              content: Container(
                width: double.maxFinite,
                height: 400,
                child: Column(
                  children: [
                    if (isScanning)
                      Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          children: [
                            CircularProgressIndicator(
                              color: Colors.blueAccent,
                              strokeWidth: 3,
                            ),
                            SizedBox(height: 10),
                            Text(
                              "Scanning for devices...",
                              style: TextStyle(
                                color: Colors.grey[600],
                                fontStyle: FontStyle.italic,
                              ),
                            ),
                          ],
                        ),
                      ),
                    Expanded(
                      child: filteredResults.isEmpty
                          ? Center(
                              child: Text(
                                isScanning
                                    ? "Searching nearby devices..."
                                    : "No devices found.",
                                style: TextStyle(color: const Color.fromARGB(255, 10, 10, 10)),
                              ),
                            )
                          : ListView.separated(
                              itemCount: filteredResults.length,
                              separatorBuilder: (_, __) =>
                                  Divider(color: Colors.grey[300]),
                              itemBuilder: (context, index) {
                                final result = filteredResults[index];
                                final device = result.device;
                                final name = device.platformName;

                                return ListTile(
                                  leading: Icon(Icons.devices_other,
                                      color: Colors.blueAccent),
                                  title: Text(
                                    name,
                                    style: TextStyle(
                                      color: const Color.fromARGB(255, 75, 75, 75),
                                      fontWeight: FontWeight.w600,
                                    ),
                                  ),
                                  subtitle: Text(device.remoteId.toString()),
                                  trailing: Text(
                                    '${result.rssi} dBm',
                                    style: TextStyle(color: Colors.grey[700]),
                                  ),
                                  onTap: () {
                                    Navigator.pop(context);
                                    // connectToDevice(device);
                                  },
                                );
                              },
                            ),
                    ),
                  ],
                ),
              ),
              actionsPadding:
                  EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),
              actions: [
                ElevatedButton.icon(
                  style: ElevatedButton.styleFrom(
                    backgroundColor:
                        isScanning ? Colors.redAccent : Colors.blueAccent,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  icon: Icon(
                    isScanning ? Icons.stop : Icons.search,
                    color: Colors.white,
                  ),
                  label: Text(
                    isScanning ? 'Stop Scan' : 'Start Scan',
                    style: TextStyle(color: Colors.white),
                  ),
                  onPressed: () {
                    if (isScanning) {
                      stopScan();
                    } else {
                      startScan();
                      // Automatically stop after 10 seconds
                      Future.delayed(Duration(seconds: 10), () {
                        if (isScanning) {
                          stopScan();
                          setDialogState(() {});
                        }
                      });
                    }
                    setDialogState(() {});
                  },
                ),
                TextButton(
                  onPressed: () => Navigator.pop(context),
                  child: Text(
                    'Close',
                    style: TextStyle(color: Colors.grey[700]),
                  ),
                ),
              ],
            );
          },
        );
      },
    );
  }

  
  Future<void> startScan() async {
    try {
      setState(() {
        isScanning = true;
        scanResults.clear();
      });

      await FlutterBluePlus.startScan(
        timeout: Duration(seconds: 10),
        androidUsesFineLocation: true,
      );

      scanSubscription = FlutterBluePlus.scanResults.listen((results) {
        setState(() {
          scanResults = results;
        });
      });

      await Future.delayed(Duration(seconds: 15));
      await stopScan();
    } catch (e) {
      print('Error starting scan: $e');
      showError('Failed to start scan: $e');
      setState(() {
        isScanning = false;
      });
    }
  }

  
  Future<void> startScan() async {
    try {
      setState(() {
        isScanning = true;
        scanResults.clear();
      });

      await FlutterBluePlus.startScan(
        timeout: Duration(seconds: 10),
        androidUsesFineLocation: true,
      );

      scanSubscription = FlutterBluePlus.scanResults.listen((results) {
        setState(() {
          scanResults = results;
        });
      });

      await Future.delayed(Duration(seconds: 15));
      await stopScan();
    } catch (e) {
      print('Error starting scan: $e');
      showError('Failed to start scan: $e');
      setState(() {
        isScanning = false;
      });
    }
  }

  Future<void> stopScan() async {
    try {
      await FlutterBluePlus.stopScan();
      setState(() {
        isScanning = false;
      });
    } catch (e) {
      print('Error stopping scan: $e');
    }
  } 
  
  Future<void> startScan() async {
    try {
      setState(() {
        isScanning = true;
        scanResults.clear();
      });

      await FlutterBluePlus.startScan(
        timeout: Duration(seconds: 10),
        androidUsesFineLocation: true,
      );

      scanSubscription = FlutterBluePlus.scanResults.listen((results) {
        setState(() {
          scanResults = results;
        });
      });

      await Future.delayed(Duration(seconds: 15));
      await stopScan();
    } catch (e) {
      print('Error starting scan: $e');
      showError('Failed to start scan: $e');
      setState(() {
        isScanning = false;
      });
    }
  }

  void showError(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red,
        duration: Duration(seconds: 3),
      ),
    );
  }

  void showSuccess(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.green,
        duration: Duration(seconds: 2),
      ),
    );
  }

  Future<void> disconnectDevice() async {
    if (connectedDevice != null) {
      try {
        await connectedDevice!.disconnect();
        setState(() {
          isConnected = false;
          connectedDevice = null;
          txCharacteristic = null;
        });
        showSuccess('Bluetooth Disconnected');
      } catch (e) {
        print('Error disconnecting: $e');
      }
    }
  }

  Future<void> sendData(String command) async {
    if (txCharacteristic == null || !isConnected) {
      print('‚ùå Cannot send ‚Äì Not connected or no TX characteristic');
      return;
    }

    List<int> bytes = command.codeUnits;
    await txCharacteristic!.write(bytes, withoutResponse: false);

    print('üì§ Sent command: $command ‚Üí bytes: $bytes');
  }